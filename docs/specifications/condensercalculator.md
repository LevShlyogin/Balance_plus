# Спецификация продукта «Модуль расчета конденсаторов»

---

**Раздел 1. Общая информация**

| Поле | Значение |
|------|----------|
| Название продукта | Расчётный модуль «Конденсаторы» (Condensers Calc) |
| Заказчик (отдел/человек) | Отдел инженерных расчётов (БТР, БПР, БВП) / Деминов А.М. |
| Аналитик | Шлегин Л.Р., Гаврилов П.Я. |
| Дата передачи в разработку | 16.12.2025 |
| Приоритет | Высокий (Замена Excel-макросов) |
| Целевой срок Demo | Q3 2026 |
| Версия | 1.1 |

---

**Раздел 2. Проблема и цель**

> **Проблема:**
> Текущий процесс расчета конденсаторов фрагментирован и выполняется с помощью Legacy-макроса в Excel.
> - Отсутствует версионирование и централизованное хранение данных (геометрия, результаты).
> - Отсутствует единая БД геометрии конденсаторов.
> - Разрыв контекста: ручной перенос данных (PDF-чертежи → Excel ИД/Результаты).
> - Высокая трудоемкость подготовки данных и формирования таблиц режимов.
>
> **Цель:**
> Автоматизировать расчет конденсаторов в «Едином окне»:
> 1. Создать БД геометрии конденсаторов (включая диапазоны расходов).
> 2. Реализовать расчет по методикам Бермана и Метро-Виккерса.
> 3. Реализовать генерацию многомерных таблиц результатов (параметрический анализ) автоматически.
>
> **Критерий успеха:**
> - Точность расчета: отклонение от текущих методик < 0.1%.
> - Время выполнения расчета: < 0.2 сек.
> - Бесшовная передача данных: БД геометрии → Расчет → БД результатов (для Balance+).
> - Поддержка синтаксиса диапазонов (напр., `1000 2000` или `10-50-5`) во входных полях.

---

**Раздел 3. Пользователи и роли**

| Роль | Кто это | Что делает в системе |
|------|---------|---------------------|
| Инженер-расчётчик | Сотрудники бюро (БТР, БПР, БВП) | Выбирает конденсатор из БД, задает методику и термодинамические параметры (в т.ч. диапазоны), выполняет расчет, анализирует таблицы результатов, сохраняет в Git/Excel. |

---

**Раздел 4. Функциональные требования (Use Cases)**

**UC-01: Расчет в контексте задачи (Интеграция)**

| Поле | Описание |
|------|----------|
| Актор | Инженер-расчётчик |
| Предусловие | Задача выбрана в Task Manager. |
| Основной сценарий | 1. Система проверяет наличие файла результатов (`JSON`) в репозитории.<br>2. **Если файл есть (Гидрация):**<br>   - Автоматически выбирается конденсатор по ID.<br>   - Устанавливается сохраненная методика (Берман/Метро-Виккерс).<br>   - Поля заполняются сохраненными значениями (в т.ч. массивами данных).<br>3. **Если файла нет:**<br>   - Пользователь ищет и выбирает конденсатор (UC-02).<br>   - Выбирает методику расчета (по умолчанию блокируются лишние поля).<br>4. Пользователь вводит/корректирует параметры (поддерживается ввод диапазонов).<br>5. Нажимает «Рассчитать».<br>6. Система генерирует серию таблиц результатов.<br>7. Пользователь нажимает «Отправить результаты в GitLab». |

**UC-02: Поиск и выбор оборудования**

| Поле | Описание |
|------|----------|
| Актор | Инженер-расчётчик |
| Основной сценарий | 1. Пользователь переходит на вкладку поиска.<br>2. Вводит маркировку или проект.<br>3. Система отображает найденные конденсаторы.<br>4. Пользователь выбирает оборудование.<br>5. Система проверяет полноту данных в БД для выбранной методики (BR-02). |

---

**Раздел 5. Бизнес-правила (Логика расчета)**

| ID | Правило | Описание / Логика |
|----|---------|-------------------|
| BR-01 | **Выбор методики** | При выборе методики UI блокирует (делает серыми) неиспользуемые поля:<br>**Берман:** Доступны `b`, `Gk`, `W_op`, `W_vp`, `Zej`, `Zop`, `Zvp`, `t1_op`, `t1_vp`, `hk`.<br>**Метро-Виккерс:** Доступны `b`, `Gk`, `W_op`, `x`. |
| BR-02 | **Валидация БД** | Перед расчетом система проверяет наличие обязательных геометрических констант в БД для выбранной методики. Если данных нет — блокировать кнопку расчета и вывести ошибку. |
| BR-03 | **Значения по умолчанию** | `b = 1`, `Zej = 1`, `x = 0.950`. |
| BR-04 | **Синхронизация температур** | Принимается, что `t1_op = t1_vp`. При вводе значения в одно поле, оно дублируется во второе (если не задано явно иное). |
| BR-05 | **Интерполяция загрязнения (b)** | Диапазон `b`: [0 ... 1].<br>- Если `b` в диапазоне [0.75 ... 1]: Линейная интерполяция коэффициента сопротивления.<br>- Если `b` < 0.75: Линейная экстраполяция.<br>- Если `b` > 1 или < 0: Ошибка валидации. |
| BR-06 | **Лимиты расходов (Pass limits)** | Проверять введенные `W_op`, `W_vp` по справочнику БД (min/max для конкретного числа ходов).<br>**Реакция:** Warning (Предупреждение), но расчет не блокировать. |
| BR-07 | **Лимиты одного пучка** | Проверять расходы при работе только одного пучка (данные из БД).<br>**Реакция:** Warning. |
| BR-08 | **Парсинг ввода (Range Input)** | Поля параметров поддерживают синтаксис:<br>1. Число: `1000`<br>2. Список: `1000 2000 3000` (через пробел)<br>3. Диапазон: `10-50-10` (Start-End-Step) → `10, 20, 30, 40, 50`<br>4. Количество точек: `10-50:5` (Start-End:Count) → 5 точек от 10 до 50. |
| BR-09 | **Логика матричного расчета** | 1. **Zipped Loop:** Массивы `W_op` и `W_vp` должны быть одной длины. Они перебираются синхронно (пара `W_op[i] + W_vp[i]`).<br>2. **Outer Loop:** Если задано несколько `b`, для каждого создается отдельный набор таблиц.<br>3. **Matrix Loop:** Для каждой комбинации (b, W) строится таблица, где оси — это массивы `t1` (строки) и `Gk` (столбцы).<br>4. В ячейках таблицы — искомое давление `Pk`. |
| BR-10 | **Температурные диапазоны** | **Берман:** Оптимален для 0...35°С. Если `t1` вне диапазона — Warning.<br>**Метро-Виккерс:** Оптимален для 35...150°С. Если `t1` вне диапазона — Warning. |
| BR-11 | **Экстраполяция MV** | Для Метро-Виккерс: если расчет попадает в расширенную (достроенную) часть кривой коэффициента K — выводить Warning: *"Данные не подтверждены экспериментально"*. |
| BR-12 | **Свойства материалов** | Необходимые свойства материалов подтягиваются из библиотеки материалов применяемых на предприятии. |

---

**Раздел 6. Данные**

**6.1. Входные данные (Пользовательский ввод)**

В UI все поля должны иметь Dropdown для смены размерности (но расчет ведется в системных единицах).

| Название | Код | Ед. изм. (Default) | Точность UI | Тип ввода |
| :--- | :---: | :---: | :---: | :--- |
| Коэфф. загрязнения | `b` | - | 0.01 | Array |
| Расход пара в к-р | `Gk` | т/ч | 0.01 | Array (Axis X) |
| Расход охл. воды (встр. пучок) | `W_vp` | т/ч | 0 | Array (Zipped) |
| Расход охл. воды (осн. пучок) | `W_op` | т/ч | 0 | Array (Zipped) |
| Кол-во раб. эжекторов | `Zej` | шт | 0 | Single |
| Ходы воды (встр. пучок) | `Zvp` | шт | 0 | Single |
| Ходы воды (осн. пучок) | `Zop` | шт | 0 | Single |
| Темп. воды вход (встр. пучок) | `t1_vp` | °С | 0.1 | Array (Axis Y) |
| Темп. воды вход (осн. пучок) | `t1_op` | °С | 0.1 | Array (Axis Y) |
| Энтальпия пара | `hk` | ккал/кг | 0.1 | Single |
| Степень сухости | `x` | - | 0.001 | Single |

**6.2. Выходные данные**

| Название | Код | Ед. изм. | Точность UI | Комментарий |
| :--- | :---: | :---: | :---: | :--- |
| Давление в конденсаторе | `Pk` | кгс/см² | 4 зн. цифры | Основной результат (матрица) |

**6.3. Концептуальная модель данных (Frontend State)**

```json
{
  "taskId": "123",
  "configuration": {
    "condenserId": "uuid-condenser-db",
    "method": "berman" // or "metro-vickers"
  },
  "inputs": {
    "b": [1, 0.75],
    "W_op": [1000, 2000],
    "W_vp": [500, 750], // Длина должна совпадать с W_op
    "Gk": [8, 20, 50],
    "t1_op": [10, 20],
    "hk": 560
    // ... остальные параметры
  },
  "results": [
    {
      "meta": { "b": 1, "W_op": 1000, "W_vp": 500 },
      "matrix": {
        "columns": [8, 20, 50], // Gk
        "rows": [10, 20],       // t1
        "values": [             // Pk
          [0.0451, 0.0520, 0.0610],
          [0.0650, 0.0710, 0.0820]
        ]
      }
    },
    {
      "meta": { "b": 1, "W_op": 2000, "W_vp": 750 },
      "matrix": { ... }
    }
    // ... блоки для других комбинаций
  ]
}
```

---

**Раздел 7. Прототип интерфейса**

**Экран 1: Настройка расчёта**
*   **Header:** Выбор конденсатора (Карточка с краткими хар-ками). Кнопка "Сменить".
*   **Method Selector:** Radio buttons [ Методика Бермана | Методика Метро-Виккерса ].
*   **Input Grid:**
    *   Поля группируются логически (Вода, Пар, Конструктив).
    *   Поля, недоступные для выбранной методики, визуально "задизейблены" (серый фон).
    *   Поля поддерживают валидацию диапазонов (tooltip с подсказкой формата ввода `10-50-5`).
    *   Рядом с полями `W_op`/`W_vp` индикатор диапазона из БД (напр., "Допустимо: 800-2500").
*   **Action Panel:** Кнопка "Рассчитать".

**Экран 2: Результаты (Matrix View)**
*   **Группировка:** Сверху табы или аккордеон для переключения между "Кейсами" (комбинации `b` и `W`).
    *   *Пример заголовка таба:* `b=1, W_op=1000, W_vp=500`.
*   **Таблица:**
    *   Заголовки столбцов: Значения `Gk`.
    *   Заголовки строк: Значения `t1`.
    *   Ячейки: Значение `Pk`.
    *   Цветовое кодирование: Если значение экстраполировано или есть Warning — ячейка подсвечивается желтым (tooltip с деталями).
*   **Footer:** Кнопки "В Excel" (скачивание .xlsx), "Сохранить в GitLab".

Пример вывода данных:

 b=1 W_op=1000 W_vp=500
| t1_op \ Gk | 8 | 20 | 50 |
| :---: | :---: | :---: | :---: |
| 10 | P1 | P2 | P3 |
| 20 | P4 | P5 | P6 |

b=1 W_op=2000 W_vp=750
| t1_op \ Gk | 8 | 20 | 50 |
| :---: | :---: | :---: | :---: |
| 10 | P7 | P8 | P9 |
| 20 | P10 | P11 | P12 |

 b=0.75 W_op=1000 W_vp=500
| t1_op \ Gk | 8 | 20 | 50 |
| :---: | :---: | :---: | :---: |
| 10 | P13 | P14 | P15 |
| 20 | P16 | P17 | P18 |

b=0.75 W_op=2000 W_vp=750
| t1_op \ Gk | 8 | 20 | 50 |
| :---: | :---: | :---: | :---: |
| 10 | P19 | P20 | P21 |
| 20 | P22 | P23 | P24 |

---

**Раздел 8. Согласования**

| Роль | ФИО | Подпись/дата |
|------|-----|--------------|
| Заказчик | Деминов А.М. | |
| Аналитик | Шлегин Л.Р., Гаврилов П.Я. | |

---

**Definition of Ready (Критерии готовности к передаче)**

Задача считается выполненной, если:
1.  Спецификация утверждена заказчиком.
2.  БД конденсаторов наполнена тестовыми данными (минимум 3 типа с диапазонами расходов).
3.  Реализован парсер входных строк (Range/List parser) на фронтенде или бэкенде.
4.  Математическое ядро поддерживает векторизированный расчет (генерация матриц).
5.  Реализован экспорт результатов в Excel в требуемом формате.
6.  Интеграция: результаты сохраняются в JSON, который может прочитать программа «Баланс».

