# **Архитектура Системы "Balance+" (C4 Model - Level 2: Контейнеры)**

**Версия:** 1.0  
**Статус:** Утверждено

## 1. Введение

Этот документ детализирует внутреннее устройство системы "Balance+ IDE". Он представляет архитектуру на уровне "Контейнеров" в соответствии с моделью C4.

Под "Контейнером" здесь понимается отдельная развертываемая единица (deployable unit), такая как:
*   Веб-приложение на стороне клиента (SPA).
*   Backend-микросервис (например, Docker-контейнер).
*   Хранилище данных (например, база данных).
*   Система обмена сообщениями (брокер очередей).

Эта диаграмма отвечает на вопросы: "Из каких основных блоков состоит система?", "Какова их ответственность?" и "Как они общаются друг с другом?".

## 2. Диаграмма Контейнеров

```mermaid
graph TD
    %% Определяем внешние системы и пользователей
    User("<b>Инженер / Руководитель</b><br/><i>[Пользователь]</i>")
    GitLab("
        <b>GitLab</b><br/>
        <i>[Внешняя система]</i><br/>
        Источник правды для кода и данных
    ")

    %% Начинаем описывать нашу систему
    subgraph "Система 'Balance+ IDE'"
        
        %% Клиентский уровень
        Frontend["
            <b>Frontend IDE</b><br/>
            <i>[Single-Page Application, TypeScript/React]</i><br/>
            Предоставляет пользовательский интерфейс в браузере.
        "]

        %% Уровень Backend API (Синхронное взаимодействие)
        subgraph "Backend API"
            API_GW["
                <b>API Gateway</b><br/>
                <i>[Python/FastAPI]</i><br/>
                Единая точка входа, аутентификация, маршрутизация.
            "]
            Orchestrator["
                <b>Сервис Оркестрации</b><br/>
                <i>[Python/FastAPI, Celery Producer]</i><br/>
                Управляет бизнес-процессами (Сагами), работает с GitLab.
            "]
        end

        %% Уровень асинхронной обработки (Workers)
        subgraph "Асинхронные обработчики (Workers)"
            Workers["
                <b>Расчётные Микросервисы</b><br/>
                <i>[Python/Celery Workers]</i><br/>
                Изолированные сервисы для каждого типа расчёта<br/>
                (Конденсатор, Штоки и т.д.).
            "]
        end

        %% Уровень инфраструктуры и данных
        subgraph "Инфраструктура и Хранилища"
            Broker["
                <b>Message Broker</b><br/>
                <i>[RabbitMQ]</i><br/>
                Обеспечивает асинхронное взаимодействие.
            "]
            OrchestratorDB[("
                <b>PostgreSQL DB</b><br/>
                <i>[Реляционная СУБД]</i><br/>
                Хранит состояние активных Саг.
            ")]
            Observability["
                <b>Система Наблюдаемости</b><br/>
                <i>[Prometheus, Loki, Jaeger, Grafana]</i><br/>
                Сбор и анализ телеметрии.
            "]
        end
    end

    %% --- Связи ---
    User -- "[HTTPS] Работает с" --> Frontend
    Frontend -- "[HTTPS] API-запросы" --> API_GW
    
    API_GW -- "[HTTP] Проксирует запросы" --> Orchestrator
    
    Orchestrator -- "[AMQP] Публикует задачу" --> Broker
    Orchestrator -- "[SQL] Читает/пишет состояние Саги" --> OrchestratorDB
    Orchestrator -- "[API/Git] Управляет репозиториями" --> GitLab
    
    Broker -- "[AMQP] Доставляет задачу" --> Workers
    Workers -- "[Git+SSH] Читает/пишет данные" --> GitLab
    
    %% --- Сквозные связи ---
    API_GW -- "[Logs, Metrics, Traces]" --> Observability
    Orchestrator -- "[Logs, Metrics, Traces]" --> Observability
    Workers -- "[Logs, Metrics, Traces]" --> Observability
    Broker -- "[Metrics, Logs]" --> Observability

    %% --- Стилизация ---
    style Frontend fill:#a2d2ff,stroke:#00509d
    style API_GW fill:#ade8f4,stroke:#0077b6
    style Orchestrator fill:#ade8f4,stroke:#0077b6
    style Workers fill:#caf0f8,stroke:#0096c7
```

## 3. Описание компонентов

| Контейнер | Описание | Технологии |
| :--- | :--- | :--- |
| **Frontend IDE** | Клиентское SPA-приложение, работающее в браузере пользователя. Отвечает за весь пользовательский интерфейс, визуализацию данных и взаимодействие с Backend API. | TypeScript, React |
| **API Gateway** | Единственная точка входа для Frontend. Выполняет аутентификацию (валидацию JWT-токенов от GitLab), логирование и маршрутизацию запросов к внутренним сервисам. Выступает в роли фасада. | Python, FastAPI |
| **Сервис Оркестрации** | "Мозг" системы. Реализует сложную бизнес-логику (Саги). Управляет состоянием долгоживущих процессов, взаимодействует с GitLab API и отправляет асинхронные задачи на выполнение. | Python, FastAPI, Celery (как Producer) |
| **Расчётные Микросервисы** | Пул независимых `worker`-сервисов. Каждый `worker` отвечает за один конкретный тип расчёта. Они "слушают" свою очередь в брокере, выполняют вычисления и сохраняют результат в Git. | Python, Celery (как Worker) |
| **PostgreSQL DB** | Персистентное хранилище, используемое **только** Сервисом Оркестрации для сохранения состояния активных Саг. Это позволяет восстанавливать прерванные процессы после сбоя. | PostgreSQL |
| **Message Broker** | Обеспечивает асинхронную коммуникацию. Оркестратор публикует в него задачи, а `worker`'ы их забирают. Это развязывает компоненты и повышает отказоустойчивость. | RabbitMQ |
| **Система Наблюдаемости** | Комплекс инструментов для сбора, хранения и визуализации метрик, логов и трейсов со всех компонентов системы. | Prometheus, Loki, Jaeger, Grafana |

## 4. Поток данных: Сценарий "Запуск расчёта"

Чтобы проиллюстрировать взаимодействие, рассмотрим упрощенный поток данных при запуске пользователем одного из расчётов:

1.  **Пользователь** нажимает кнопку "Рассчитать" в **Frontend IDE**.
2.  **Frontend IDE** отправляет API-запрос (HTTPS) на **API Gateway**.
3.  **API Gateway** валидирует токен пользователя, добавляет заголовки для трассировки и проксирует запрос на **Сервис Оркестрации**.
4.  **Сервис Оркестрации**:
    a. Начинает бизнес-процесс (Сагу).
    b. Сохраняет/обновляет состояние Саги в своей **PostgreSQL DB**.
    c. Через API **GitLab** создает коммит с входными данными.
    d. Публикует сообщение-задачу в **Message Broker (RabbitMQ)**.
5.  **Расчётный Микросервис (Worker)**, подписанный на нужную очередь, забирает сообщение из **RabbitMQ**.
6.  **Worker**:
    a. Клонирует/обновляет репозиторий из **GitLab**.
    b. Выполняет вычисления.
    c. Создает новый коммит с результатами и отправляет его в **GitLab**.
7.  **На протяжении всего процесса** все сервисы отправляют логи, метрики и трейсы в **Систему Наблюдаемости**.
